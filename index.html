<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="description" content="Sistema de inventario y mantenimiento de tablets - Fundaci√≥n Carlos F. Novella">
  <meta name="theme-color" content="#2d7a3e">
  
  <title>Inventario de Tablets - Fundaci√≥n Carlos F. Novella</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="assets/icons/icon-72.png">
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png">
  
  <!-- Styles -->
  <link rel="stylesheet" href="css/styles.css?v=3">
</head>
<body>

  <!-- ================================
       SPLASH SCREEN
       ================================ -->
  <div id="splash-screen" class="splash-screen">
    <div class="splash-logo">üì±</div>
    <h1>Inventario de Tablets</h1>
    <p>Fundaci√≥n Carlos F. Novella</p>
    <div class="splash-spinner"></div>
  </div>

  <!-- ================================
       OFFLINE INDICATOR
       ================================ -->
  <div id="offline-indicator" class="offline-indicator" style="display: none;">
    ‚ö†Ô∏è Sin conexi√≥n - Trabajando en modo offline
  </div>

  <!-- ================================
       MAIN APP
       ================================ -->
  <div id="app" style="display: none;">
    
    <!-- ================================
         HEADER
         ================================ -->
    <header class="header">
      <div class="header-content">
        <div class="header-title">
          <div class="header-logo">üì±</div>
          <div>
            <h1>Inventario Tablets</h1>
            <p>Fundaci√≥n Carlos F. Novella</p>
          </div>
        </div>
        <div class="header-actions">
          <button id="sync-btn" class="header-btn" title="Sincronizar">
            üîÑ
            <span id="sync-status" class="sync-badge">0</span>
          </button>
          <button id="export-btn" class="header-btn" title="Exportar">
            üì•
          </button>
          <button id="user-menu-btn" class="header-btn" title="Usuario">
            üë§
          </button>
          <div id="user-menu" class="user-menu" style="display: none;">
            <div class="user-menu-item">
              <span id="user-name">Usuario</span>
            </div>
            <div class="user-menu-item">
              <span id="user-role">Rol</span>
            </div>
            <div class="user-menu-divider"></div>
            <button id="logout-btn" class="user-menu-item">
              üö™ Cerrar Sesi√≥n
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- ================================
         DASHBOARD VIEW
         ================================ -->
    <div id="dashboard-view" class="view active">
      <div class="container">
        
        <!-- Statistics -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">üíª</div>
            <div class="stat-value" id="stat-total">0</div>
            <div class="stat-label">Total Tablets</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-value" id="stat-good">0</div>
            <div class="stat-label">Buen Estado</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚ö†Ô∏è</div>
            <div class="stat-value" id="stat-attention">0</div>
            <div class="stat-label">Requieren Atenci√≥n</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚è≥</div>
            <div class="stat-value" id="stat-pending">0</div>
            <div class="stat-label">Pendientes Sincronizar</div>
          </div>
        </div>

        <!-- Search and Filters -->
        <div class="search-section">
          <div class="search-bar">
            <span class="search-icon">üîç</span>
            <input type="text" id="search-input" placeholder="Buscar por c√≥digo, modelo, sede...">
          </div>
          <div class="filters">
            <select id="filter-sede">
              <option value="">Todas las sedes</option>
            </select>
            <select id="filter-estado">
              <option value="">Todos los estados</option>
              <option value="Bueno">Bueno</option>
              <option value="Funcional">Funcional</option>
              <option value="Regular">Regular</option>
              <option value="Con rayones">Con rayones</option>
              <option value="Malo">Malo</option>
              <option value="Roto">Roto</option>
            </select>
            <button id="export-btn" class="btn-secondary">
              üì• Exportar
            </button>
          </div>
        </div>

        <!-- Tablets List -->
        <div id="tablets-list" class="tablets-grid"></div>

        <!-- Empty State -->
        <div id="empty-state" class="empty-state">
          <div class="empty-state-icon">üì±</div>
          <h3>No hay tablets registradas</h3>
          <p>Agrega tu primera tablet usando el bot√≥n +</p>
        </div>

      </div>
    </div>

    <!-- ================================
         FORM VIEW
         ================================ -->
    <div id="form-view" class="view">
      <div class="container">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
          <button id="back-btn" class="header-btn" style="background: var(--primary-green);">
            ‚Üê 
          </button>
          <h2 id="form-title">Agregar Tablet</h2>
        </div>

        <form id="tablet-form">
          
          <!-- Escanear Informaci√≥n -->
          <div class="form-section">
            <h3>Escanear Informaci√≥n</h3>
            <div class="camera-buttons">
              <button type="button" id="start-camera-btn" class="btn-secondary">
                üì∑ Usar C√°mara
              </button>
              <button type="button" id="upload-image-btn" class="btn-secondary">
                üñºÔ∏è Subir Foto
              </button>
              <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
            </div>
            <div id="camera-preview" class="camera-preview">
              <video id="camera-video" autoplay playsinline></video>
              <canvas id="camera-canvas"></canvas>
              <button type="button" id="capture-btn" class="btn-primary" style="margin-top: 1rem;">
                üì∏ Capturar
              </button>
            </div>
            <div id="ocr-preview" class="ocr-preview">
              <img id="ocr-preview-image" alt="Preview">
            </div>
          </div>

          <!-- Informaci√≥n B√°sica -->
          <div class="form-section">
            <h3>Informaci√≥n B√°sica</h3>
            <div class="form-group">
              <label for="codigo_unico">C√≥digo √önico *</label>
              <input type="text" id="codigo_unico" name="codigo_unico" required readonly>
            </div>
            <div class="form-group">
              <label for="numero_serie">N√∫mero de Serie *</label>
              <input type="text" id="numero_serie" name="numero_serie" required>
            </div>
            <div class="form-group">
              <label for="modelo">Modelo *</label>
              <input type="text" id="modelo" name="modelo" required>
            </div>
            <div class="form-group">
              <label for="nombre_producto">Nombre del Producto</label>
              <input type="text" id="nombre_producto" name="nombre_producto">
            </div>
            <div class="form-group">
              <label for="numero_modelo">N√∫mero de Modelo</label>
              <input type="text" id="numero_modelo" name="numero_modelo">
            </div>
            <div class="form-group">
              <label for="sede_procedencia">Sede de Procedencia *</label>
              <select id="sede_procedencia" name="sede_procedencia" required>
                <option value="">Seleccionar sede</option>
                <option value="Sede Central">Sanarate (EP)</option>
                <option value="Sede Norte">La Pedrera (LP)</option>
                <option value="Sede Sur">San Juan Sacatep√©quez (SJ)</option>
                <option value="Sede Este">Santo Domingo Xenacoj (SDX)</option>
                <option value="Sede Oeste">Sin sede</option>
              </select>
            </div>
          </div>

          <!-- Informaci√≥n T√©cnica -->
          <div class="form-section">
            <h3>Informaci√≥n T√©cnica</h3>
            <div class="form-group">
              <label for="version_android">Versi√≥n de Android</label>
              <input type="text" id="version_android" name="version_android" placeholder="Ej: Android 11">
            </div>
            <div class="form-group">
              <label for="nivel_bateria">Nivel de Bater√≠a (%)</label>
              <input type="range" id="nivel_bateria_slider" min="0" max="100" value="0" style="width: 100%;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                <input type="number" id="nivel_bateria" name="nivel_bateria" min="0" max="100" value="0" style="width: 80px;">
                <span id="nivel_bateria_display" style="font-weight: 600; color: var(--primary-green);">0%</span>
              </div>
            </div>
          </div>

          <!-- Estado del Dispositivo -->
          <div class="form-section">
            <h3>Estado del Dispositivo</h3>
            <div class="form-group">
              <label for="estado_pantalla">Estado de Pantalla *</label>
              <select id="estado_pantalla" name="estado_pantalla" required>
                <option value="">Seleccionar estado</option>
                <option value="Bueno">Bueno</option>
                <option value="Con rayones">Con rayones</option>
                <option value="Roto">Roto</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div id="estado_pantalla_otro_group" class="form-group" style="display: none;">
              <label for="estado_pantalla_otro">Especificar otro estado de pantalla</label>
              <input type="text" id="estado_pantalla_otro" name="estado_pantalla_otro">
            </div>
            <div class="form-group">
              <label for="estado_puerto_carga">Estado del Puerto de Carga *</label>
              <select id="estado_puerto_carga" name="estado_puerto_carga" required>
                <option value="">Seleccionar estado</option>
                <option value="Funcional">Funcional</option>
                <option value="Suelto">Suelto</option>
                <option value="Da√±ado">Da√±ado</option>
              </select>
            </div>
            <div class="form-group">
              <label for="estado_fisico_general">Estado F√≠sico General *</label>
              <select id="estado_fisico_general" name="estado_fisico_general" required>
                <option value="">Seleccionar estado</option>
                <option value="Excelente">Excelente</option>
                <option value="Bueno">Bueno</option>
                <option value="Regular">Regular</option>
                <option value="Malo">Malo</option>
                <option value="Otro">Otro</option>
              </select>
            </div>
            <div id="estado_fisico_otro_group" class="form-group" style="display: none;">
              <label for="estado_fisico_otro">Especificar otro estado f√≠sico</label>
              <input type="text" id="estado_fisico_otro" name="estado_fisico_otro">
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="tiene_cargador" name="tiene_cargador">
                <span>Tiene cargador</span>
              </label>
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" id="tiene_cable" name="tiene_cable">
                <span>Tiene cable de carga</span>
              </label>
            </div>
          </div>

          <!-- Observaciones -->
          <div class="form-section">
            <h3>Observaciones</h3>
            <div class="form-group">
              <label for="observaciones">Observaciones Adicionales</label>
              <textarea id="observaciones" name="observaciones" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="hallazgos_relevantes">Hallazgos Relevantes</label>
              <textarea id="hallazgos_relevantes" name="hallazgos_relevantes" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="fecha_mantenimiento">Fecha de Mantenimiento *</label>
              <input type="date" id="fecha_mantenimiento" name="fecha_mantenimiento" required>
            </div>
          </div>

          <!-- Fotos de Evidencia -->
          <div class="form-section">
            <h3>Fotos de Evidencia</h3>
            <button type="button" id="add-evidence-btn" class="btn-secondary">
              üì∑ Agregar Fotos
            </button>
            <input type="file" id="evidence-upload-input" accept="image/*" multiple style="display: none;">
            <div id="evidence-preview" class="evidence-preview"></div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button type="button" id="cancel-form-btn" class="btn-secondary">
              Cancelar
            </button>
            <button type="submit" class="btn-primary">
              üíæ Guardar
            </button>
          </div>

        </form>
      </div>
    </div>

    <!-- ================================
         DETAIL VIEW
         ================================ -->
    <div id="detail-view" class="view">
      <div class="container">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
          <button id="detail-back-btn" class="header-btn" style="background: var(--primary-green);">
            ‚Üê
          </button>
          <h2>Detalles de Tablet</h2>
        </div>

        <div id="tablet-detail-content"></div>

        <div class="form-actions">
          <button id="delete-tablet-btn" class="btn-danger">
            üóëÔ∏è Eliminar
          </button>
          <button id="edit-tablet-btn" class="btn-primary">
            ‚úèÔ∏è Editar
          </button>
        </div>
      </div>
    </div>

    <!-- ================================
         FAB (Floating Action Button)
         ================================ -->
    <button id="fab" class="fab" title="Agregar Tablet">
      +
    </button>

  </div>

  <!-- ================================
       EXPORT MODAL
       ================================ -->
  <div id="export-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Exportar Datos</h2>
        <button class="btn-close" data-modal="export-modal">‚úï</button>
      </div>
      <div class="modal-body">
        <p>Selecciona el formato de exportaci√≥n:</p>
        <button id="export-excel" class="btn-primary btn-block" style="margin-bottom: 0.5rem;">
          üìä Excel (.xlsx)
        </button>
        <button id="export-csv" class="btn-primary btn-block" style="margin-bottom: 0.5rem;">
          üìÑ CSV
        </button>
        <button id="export-pdf" class="btn-primary btn-block">
          üìë PDF
        </button>
      </div>
    </div>
  </div>

  <!-- ================================
       TOAST CONTAINER
       ================================ -->
  <div id="toast-container" class="toast-container"></div>

  <!-- ================================
       SCRIPTS
       ================================ -->
  <script>
    // Funci√≥n para cargar scripts con fallback
    function loadScriptWithFallback(src, fallbackSrc = null) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
          console.log(`‚úì Loaded: ${src}`);
          resolve();
        };
        script.onerror = () => {
          console.warn(`‚úó Failed to load: ${src}`);
          if (fallbackSrc) {
            console.log(`Trying fallback: ${fallbackSrc}`);
            const fallbackScript = document.createElement('script');
            fallbackScript.src = fallbackSrc;
            fallbackScript.onload = () => {
              console.log(`‚úì Loaded fallback: ${fallbackSrc}`);
              resolve();
            };
            fallbackScript.onerror = () => {
              console.error(`‚úó Failed to load fallback: ${fallbackSrc}`);
              resolve();
            };
            document.head.appendChild(fallbackScript);
          } else {
            resolve();
          }
        };
        document.head.appendChild(script);
      });
    }

    // Cargar librer√≠as CDN con fallbacks
    async function loadLibraries() {
      console.log('Loading external libraries...');
      
      await loadScriptWithFallback(
        'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2',
        'https://unpkg.com/@supabase/supabase-js@2'
      );
      
      await loadScriptWithFallback(
        'https://cdn.jsdelivr.net/npm/tesseract.js@4',
        'https://unpkg.com/tesseract.js@4'
      );
      
      await loadScriptWithFallback(
        'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
        'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'
      );
      
      await loadScriptWithFallback(
        'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
        'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'
      );
      
      await loadScriptWithFallback(
        'https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js',
        'https://unpkg.com/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js'
      );

      console.log('Libraries loaded, starting app...');
      
      // Cargar scripts de la aplicaci√≥n EN ORDEN
      const appScripts = [
        'js/db.js',
        'js/supabase-client.js',
        'js/ocr.js',
        'js/camera.js',
        'js/auth.js',
        'js/sync.js',
        'js/export.js',
        'js/app.js'
      ];

      for (const src of appScripts) {
        await loadScriptWithFallback(src);
      }
      
      console.log('All scripts loaded!');
    }

    // Iniciar carga
    loadLibraries().catch(error => {
      console.error('Error loading libraries:', error);
      alert('Error al cargar la aplicaci√≥n. Por favor recarga la p√°gina.');
    });
  </script>

</body>
</html>
